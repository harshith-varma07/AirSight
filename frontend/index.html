<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirSight - Air Quality Monitor</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-bg: #0f0f23;
            --card-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b8b8b8;
            --neon-blue: #00f5ff;
            --neon-purple: #bf00ff;
            --neon-green: #39ff14;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 245, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(191, 0, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(57, 255, 20, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease-in-out infinite alternate;
        }

        @keyframes backgroundShift {
            0% { transform: translateX(0) translateY(0) rotate(0deg); }
            100% { transform: translateX(-50px) translateY(-30px) rotate(2deg); }
        }

        .navbar {
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-primary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: all 0.3s ease;
            z-index: -1;
        }

        .nav-link:hover::before {
            left: 0;
        }

        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 245, 255, 0.3);
        }

        .login-btn {
            background: var(--primary-gradient);
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.6);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 2rem 2rem;
        }

        .hero-section {
            text-align: center;
            padding: 4rem 0;
            position: relative;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 10px rgba(0, 245, 255, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(0, 245, 255, 0.8)); }
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            animation: slideInUp 1s ease-out 0.5s both;
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-container {
            display: flex;
            justify-content: center;
            margin: 3rem 0;
            animation: slideInUp 1s ease-out 0.7s both;
        }

        .search-box {
            display: flex;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 1rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            padding: 0 1rem;
            outline: none;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-btn {
            background: var(--success-gradient);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            transform: scale(1.1) rotate(360deg);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.5);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: slideInUp 1s ease-out both;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .card:hover::before {
            transform: translateX(100%);
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--neon-blue);
        }

        .aqi-display {
            text-align: center;
            margin-bottom: 2rem;
        }

        .aqi-value {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .aqi-good { color: var(--neon-green); }
        .aqi-moderate { color: #ffff00; }
        .aqi-unhealthy { color: #ff8c00; }
        .aqi-very-unhealthy { color: #ff0000; }
        .aqi-hazardous { color: #8b0000; }

        .aqi-category {
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
        }

        .progress-ring {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring circle {
            fill: transparent;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 565.48;
            stroke-dashoffset: 565.48;
            transition: stroke-dashoffset 2s ease-in-out;
        }

        .progress-bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .progress-fill {
            stroke: var(--neon-blue);
            filter: drop-shadow(0 0 10px currentColor);
        }

        .city-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .city-card {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .city-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--neon-purple);
        }

        .city-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .city-aqi {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .parameters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .parameter-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .parameter-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .parameter-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .parameter-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            animation: slideInScale 0.5s ease;
        }

        @keyframes slideInScale {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.8); 
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1); 
            }
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: var(--neon-blue);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 1rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 245, 255, 0.3);
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
            border-radius: 10px;
            padding: 1rem 2rem;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }

        .alert-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--neon-blue);
        }

        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--neon-blue);
            border-radius: 50%;
            animation: float 20s linear infinite;
            opacity: 0.6;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.6;
            }
            90% {
                opacity: 0.6;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .nav-links {
                display: none;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                margin: 0 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Particles -->
    <div class="floating-particles" id="particles"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-wind"></i> AirSight
            </div>
            <div class="nav-links">
                <a href="#" class="nav-link">Dashboard</a>
                <a href="#" class="nav-link">Cities</a>
                <a href="#" class="nav-link">Reports</a>
                <a href="#" class="nav-link">Alerts</a>
                <button class="login-btn" onclick="openModal('loginModal')">
                    <i class="fas fa-user"></i> Login
                </button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section">
            <h1 class="hero-title">Real-Time Air Quality Monitoring</h1>
            <p class="hero-subtitle">Track air pollution levels worldwide with advanced analytics and intelligent alerts</p>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search city or location..." id="citySearch">
                    <button class="search-btn" onclick="searchCity()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Fetching latest air quality data...</p>
        </div>

        <!-- Main Dashboard -->
        <div class="dashboard-grid" id="dashboard">
            <!-- Primary AQI Card -->
            <div class="card">
                <div class="aqi-display">
                    <div class="progress-ring">
                        <svg>
                            <circle class="progress-bg" cx="100" cy="100" r="90"></circle>
                            <circle class="progress-fill" cx="100" cy="100" r="90" id="aqiProgress"></circle>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div class="aqi-value aqi-good" id="mainAqi">152</div>
                            <div class="aqi-category" id="mainCategory">Moderate</div>
                        </div>
                    </div>
                    <h3 id="mainCity">Delhi, India</h3>
                    <p>Last updated: <span id="lastUpdated">2 minutes ago</span></p>
                </div>
            </div>

            <!-- Parameters Card -->
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> Air Quality Parameters</h3>
                <div class="parameters-grid" id="parametersGrid">
                    <div class="parameter-item">
                        <div class="parameter-name">PM2.5</div>
                        <div class="parameter-value" style="color: var(--neon-blue);">45.2</div>
                    </div>
                    <div class="parameter-item">
                        <div class="parameter-name">PM10</div>
                        <div class="parameter-value" style="color: var(--neon-green);">78.1</div>
                    </div>
                    <div class="parameter-item">
                        <div class="parameter-name">NO2</div>
                        <div class="parameter-value" style="color: var(--neon-purple);">32.5</div>
                    </div>
                    <div class="parameter-item">
                        <div class="parameter-name">O3</div>
                        <div class="parameter-value" style="color: #ffff00;">89.3</div>
                    </div>
                </div>
            </div>

            <!-- Trending Cities -->
            <div class="card">
                <h3><i class="fas fa-globe"></i> Global Air Quality</h3>
                <div class="city-list" id="cityList">
                    <!-- Cities will be populated dynamically -->
                </div>
            </div>

            <!-- Alerts Card -->
            <div class="card">
                <h3><i class="fas fa-bell"></i> Recent Alerts</h3>
                <div class="alert-list" id="alertList">
                    <div class="alert-item">
                        <strong>Mumbai, India</strong><br>
                        AQI exceeded threshold (150+)<br>
                        <small>15 minutes ago</small>
                    </div>
                    <div class="alert-item">
                        <strong>Beijing, China</strong><br>
                        Poor air quality detected<br>
                        <small>1 hour ago</small>
                    </div>
                </div>
                <button class="btn-primary" onclick="setAlert()" style="margin-top: 1rem;">
                    <i class="fas fa-plus"></i> Set New Alert
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close" onclick="closeModal('loginModal')">&times;</button>
            <h2>Login to AirSight Pro</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" required>
                </div>
                <button type="submit" class="btn-primary">Login</button>
            </form>
            <p style="text-align: center; margin-top: 1rem;">
                Don't have an account? <a href="#" style="color: var(--neon-blue);" onclick="closeModal('loginModal'); openModal('registerModal')">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <button class="close" onclick="closeModal('registerModal')">&times;</button>
            <h2>Register for AirSight Pro</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="regUsername" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="regPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="regPhone" placeholder="+1234567890">
                </div>
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" id="regCity" placeholder="Your city for alerts">
                </div>
                <div class="form-group">
                    <label class="form-label">Alert Threshold (AQI)</label>
                    <input type="number" class="form-input" id="regThreshold" value="100" min="0" max="500">
                    <small style="color: var(--text-secondary);">Get alerts when AQI exceeds this value</small>
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
            <p style="text-align: center; margin-top: 1rem;">
                Already have an account? <a href="#" style="color: var(--neon-blue);" onclick="closeModal('registerModal'); openModal('loginModal')">Sign in</a>
            </p>
        </div>
    </div>

    <!-- Alert Setup Modal -->
    <div class="modal" id="alertModal">
        <div class="modal-content">
            <button class="close" onclick="closeModal('alertModal')">&times;</button>
            <h2>Set Up Air Quality Alert</h2>
            <form id="alertForm">
                <div class="form-group">
                    <label class="form-label">City</label>
                    <input type="text" class="form-input" id="alertCity" placeholder="Enter city name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">AQI Threshold</label>
                    <input type="number" class="form-input" id="alertThreshold" placeholder="e.g., 150" min="0" max="500" required>
                    <small style="color: var(--text-secondary);">Get SMS alerts when AQI exceeds this value</small>
                </div>
                <button type="submit" class="btn-primary">Update Alert Settings</button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let isLoggedIn = false;
        const API_BASE_URL = 'http://localhost:8080/api';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            createParticles();
            
            // Check for existing user session
            const savedUser = localStorage.getItem('airSightUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    updateNavbarForLoggedInUser();
                } catch (e) {
                    localStorage.removeItem('airSightUser');
                }
            }
            
            loadDashboardData();
            setInterval(loadDashboardData, 300000); // Update every 5 minutes
        });

        // Create floating particles animation
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                
                // Random colors
                const colors = ['var(--neon-blue)', 'var(--neon-purple)', 'var(--neon-green)'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                particlesContainer.appendChild(particle);
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            showLoading(true);
            
            try {
                // Load available cities first
                const citiesResponse = await fetch(`${API_BASE_URL}/aqi/cities`);
                const citiesData = await citiesResponse.json();
                
                if (citiesData.success && citiesData.cities && citiesData.cities.length > 0) {
                    // Get AQI data for multiple cities
                    const topCities = citiesData.cities.slice(0, 6); // Get top 6 cities
                    const multiResponse = await fetch(`${API_BASE_URL}/aqi/multiple?${topCities.map(city => `cities=${encodeURIComponent(city)}`).join('&')}`);
                    const multiData = await multiResponse.json();
                    
                    if (multiData.success && multiData.data) {
                        const cities = Object.values(multiData.data).map(cityData => ({
                            name: cityData.city,
                            country: '',
                            aqi: cityData.aqiValue,
                            category: cityData.category,
                            coordinates: [0, 0] // We don't have coordinates from backend
                        }));
                        
                        // Update main AQI with first city
                        if (cities.length > 0) {
                            updateMainAQI(cities[0]);
                        }
                        
                        updateCityList(cities);
                        updateParameters(cities[0]); // Use first city's parameters
                    }
                } else {
                    // Fallback to default cities if no cities in database
                    const fallbackCities = [
                        { name: 'Delhi', country: 'India', aqi: 152, category: 'Moderate', coordinates: [28.6139, 77.2090] },
                        { name: 'Mumbai', country: 'India', aqi: 89, category: 'Moderate', coordinates: [19.0760, 72.8777] },
                        { name: 'Chennai', country: 'India', aqi: 67, category: 'Good', coordinates: [13.0827, 80.2707] },
                        { name: 'London', country: 'UK', aqi: 45, category: 'Good', coordinates: [51.5074, -0.1278] }
                    ];
                    
                    updateMainAQI(fallbackCities[0]);
                    updateCityList(fallbackCities);
                    updateParameters(fallbackCities[0]);
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Error loading dashboard data. Using fallback data.', 'error');
                
                // Use complete fallback
                const fallbackCities = [
                    { name: 'Delhi', country: 'India', aqi: 152, category: 'Moderate', coordinates: [28.6139, 77.2090] },
                    { name: 'Mumbai', country: 'India', aqi: 89, category: 'Moderate', coordinates: [19.0760, 72.8777] }
                ];
                updateMainAQI(fallbackCities[0]);
                updateCityList(fallbackCities);
                updateParameters(fallbackCities[0]);
            } finally {
                showLoading(false);
            }
        }

        // Update main AQI display
        function updateMainAQI(cityData) {
            const aqiElement = document.getElementById('mainAqi');
            const categoryElement = document.getElementById('mainCategory');
            const cityElement = document.getElementById('mainCity');
            const progressElement = document.getElementById('aqiProgress');

            aqiElement.textContent = cityData.aqi;
            categoryElement.textContent = cityData.category;
            cityElement.textContent = `${cityData.name}, ${cityData.country}`;

            // Update progress ring
            const circumference = 2 * Math.PI * 90;
            const progress = (cityData.aqi / 300) * circumference;
            progressElement.style.strokeDashoffset = circumference - progress;

            // Update colors based on AQI
            const color = getAQIColor(cityData.aqi);
            aqiElement.className = `aqi-value ${color}`;
            progressElement.style.stroke = getAQIColorValue(cityData.aqi);

            // Animate the value
            animateValue(aqiElement, 0, cityData.aqi, 2000);
        }

        // Update city list
        function updateCityList(cities) {
            const cityListElement = document.getElementById('cityList');
            cityListElement.innerHTML = '';

            cities.forEach((city, index) => {
                const cityCard = document.createElement('div');
                cityCard.className = 'city-card';
                cityCard.style.animationDelay = `${index * 0.1}s`;
                
                cityCard.innerHTML = `
                    <div class="city-name">${city.name}, ${city.country}</div>
                    <div class="city-aqi ${getAQIColor(city.aqi)}">${city.aqi}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${city.category}</div>
                `;
                
                cityCard.addEventListener('click', () => selectCity(city));
                cityListElement.appendChild(cityCard);
            });
        }

        // Update parameters display
        function updateParameters(cityData) {
            // If we have city data with pollutant information, use it
            // Otherwise use default parameters
            const parameters = [
                { name: 'PM2.5', value: 45.2, unit: 'µg/m³', color: 'var(--neon-blue)' },
                { name: 'PM10', value: 78.1, unit: 'µg/m³', color: 'var(--neon-green)' },
                { name: 'NO2', value: 32.5, unit: 'µg/m³', color: 'var(--neon-purple)' },
                { name: 'O3', value: 89.3, unit: 'µg/m³', color: '#ffff00' },
                { name: 'SO2', value: 15.7, unit: 'µg/m³', color: '#ff8c00' },
                { name: 'CO', value: 1.2, unit: 'mg/m³', color: '#ff6b6b' }
            ];

            const parametersGrid = document.getElementById('parametersGrid');
            parametersGrid.innerHTML = '';

            parameters.forEach((param, index) => {
                const paramElement = document.createElement('div');
                paramElement.className = 'parameter-item';
                paramElement.style.animationDelay = `${index * 0.1}s`;
                
                paramElement.innerHTML = `
                    <div class="parameter-name">${param.name}</div>
                    <div class="parameter-value" style="color: ${param.color};">${param.value}</div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary);">${param.unit}</div>
                `;
                
                parametersGrid.appendChild(paramElement);
            });
        }

        // Search city functionality
        async function searchCity() {
            const searchInput = document.getElementById('citySearch');
            const cityName = searchInput.value.trim();
            
            if (!cityName) return;

            showLoading(true);
            
            try {
                // First try to search for the city
                const response = await fetch(`${API_BASE_URL}/aqi/search?query=${encodeURIComponent(cityName)}`);
                const data = await response.json();
                
                if (data.success && data.currentData) {
                    // Update main display with found city data
                    updateMainAQI({
                        name: data.currentData.city,
                        country: '', // We don't have country info from backend
                        aqi: data.currentData.aqiValue,
                        category: data.currentData.category
                    });
                    showNotification(`Data loaded for ${data.currentData.city}!`, 'success');
                } else if (data.success && data.cities && data.cities.length > 0) {
                    // If we found matching cities, try to get data for the first one
                    const firstCity = data.cities[0];
                    const cityResponse = await fetch(`${API_BASE_URL}/aqi/current/${encodeURIComponent(firstCity)}`);
                    const cityData = await cityResponse.json();
                    
                    if (cityData.success) {
                        updateMainAQI({
                            name: cityData.data.city,
                            country: '',
                            aqi: cityData.data.aqiValue,
                            category: cityData.data.category
                        });
                        showNotification(`Data loaded for ${cityData.data.city}!`, 'success');
                    }
                } else {
                    // Try to add the city to monitoring
                    const addResponse = await fetch(`${API_BASE_URL}/aqi/cities/add?city=${encodeURIComponent(cityName)}`, {
                        method: 'POST'
                    });
                    const addData = await addResponse.json();
                    
                    if (addData.success && addData.data) {
                        updateMainAQI({
                            name: addData.data.city,
                            country: '',
                            aqi: addData.data.aqiValue,
                            category: addData.data.category
                        });
                        showNotification(`New city ${addData.data.city} added to monitoring!`, 'success');
                    } else {
                        showNotification('City not found or data unavailable. Please try another city.', 'error');
                    }
                }
            } catch (error) {
                console.error('Error searching city:', error);
                showNotification('Error searching city. Please try again.', 'error');
            } finally {
                showLoading(false);
                searchInput.value = ''; // Clear search input
            }
        }

        // Select city from list
        async function selectCity(city) {
            showLoading(true);
            
            try {
                const response = await fetch(`${API_BASE_URL}/aqi/current/${encodeURIComponent(city.name)}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    updateMainAQI({
                        name: data.data.city,
                        country: city.country || '',
                        aqi: data.data.aqiValue,
                        category: data.data.category
                    });
                    showNotification(`Switched to ${data.data.city}`, 'success');
                } else {
                    showNotification(`Unable to load data for ${city.name}`, 'error');
                }
            } catch (error) {
                console.error('Error selecting city:', error);
                showNotification(`Error loading data for ${city.name}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Modal functions
        function setAlert() {
            const authHeader = sessionStorage.getItem('authorization');
            if (!authHeader) {
                alert('Please login to set up alerts');
                openModal('loginModal');
                return;
            }
            openModal('alertModal');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            try {
                showNotification('Logging in...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = {
                        id: data.userId,
                        username: data.username,
                        email: data.email,
                        city: data.city,
                        alertThreshold: data.alertThreshold
                    };
                    isLoggedIn = true;
                    
                    // Store user session
                    localStorage.setItem('airSightUser', JSON.stringify(currentUser));
                    
                    // Update UI for logged-in user
                    updateNavbarForLoggedInUser();
                    closeModal('loginModal');
                    showNotification(`Welcome back, ${currentUser.username}!`, 'success');
                    
                    // Clear form
                    document.getElementById('loginForm').reset();
                    
                    // Load user-specific data
                    loadUserAlerts();
                    
                } else {
                    showNotification(data.message || 'Invalid credentials. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed. Please check your connection and try again.', 'error');
            }
        });

        // Alert form handler
        document.getElementById('alertForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isLoggedIn) {
                showNotification('Please login to set up alerts.', 'error');
                return;
            }
            
            const city = document.getElementById('alertCity').value;
            const threshold = document.getElementById('alertThreshold').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/alerts/create?city=${encodeURIComponent(city)}&threshold=${threshold}`, {
                    method: 'POST',
                    headers: {
                        'X-User-Id': currentUser.id.toString()
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('alertModal');
                    showNotification('Alert settings updated successfully!', 'success');
                    document.getElementById('alertForm').reset();
                    loadUserAlerts();
                } else {
                    showNotification(data.message || 'Failed to create alert. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Alert creation error:', error);
                showNotification('Failed to create alert. Please try again.', 'error');
            }
        });

        // Registration form handler
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const phoneNumber = document.getElementById('regPhone').value;
            const city = document.getElementById('regCity').value;
            const alertThreshold = document.getElementById('regThreshold').value;
            
            if (!username || !email || !password) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                showNotification('Creating account...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        phoneNumber,
                        city,
                        alertThreshold: parseInt(alertThreshold)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeModal('registerModal');
                    showNotification('Account created successfully! Please login.', 'success');
                    document.getElementById('registerForm').reset();
                    openModal('loginModal');
                } else {
                    showNotification(data.message || 'Registration failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Registration failed. Please check your connection and try again.', 'error');
            }
        });

        // Update navbar for logged-in user
        function updateNavbarForLoggedInUser() {
            const loginBtn = document.querySelector('.login-btn');
            loginBtn.innerHTML = `<i class="fas fa-user-circle"></i> ${currentUser.username}`;
            loginBtn.onclick = () => showUserMenu();
        }

        // Show user menu
        function showUserMenu() {
            // Create dropdown menu for logged-in user
            const menu = document.createElement('div');
            menu.className = 'user-menu';
            menu.style.cssText = `
                position: absolute;
                top: 100%;
                right: 0;
                background: var(--card-bg);
                backdrop-filter: blur(20px);
                border: 1px solid var(--glass-border);
                border-radius: 10px;
                padding: 1rem;
                min-width: 200px;
                z-index: 1001;
            `;
            
            menu.innerHTML = `
                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--glass-border); margin-bottom: 0.5rem;">
                    <strong>${currentUser.username}</strong><br>
                    <small style="color: var(--text-secondary);">${currentUser.email}</small>
                </div>
                <a href="#" onclick="downloadReport()" style="display: block; padding: 0.5rem 0; color: var(--text-primary); text-decoration: none;">
                    <i class="fas fa-download"></i> Download Report
                </a>
                <a href="#" onclick="viewAlerts()" style="display: block; padding: 0.5rem 0; color: var(--text-primary); text-decoration: none;">
                    <i class="fas fa-bell"></i> My Alerts
                </a>
                <a href="#" onclick="logout()" style="display: block; padding: 0.5rem 0; color: var(--text-primary); text-decoration: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            `;
            
            // Remove existing menu if any
            const existingMenu = document.querySelector('.user-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Add menu to navbar
            const navContainer = document.querySelector('.nav-container');
            navContainer.style.position = 'relative';
            navContainer.appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }

        // View alerts function
        function viewAlerts() {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.remove();
            }
            
            // Scroll to alerts section or show modal with alerts
            const alertSection = document.querySelector('.glass-card h3');
            if (alertSection) {
                alertSection.scrollIntoView({ behavior: 'smooth' });
                showNotification('Your alerts are displayed in the panel below', 'info');
            }
        }

        // Download PDF report
        async function downloadReport() {
            if (!isLoggedIn) {
                showNotification('Please login to download reports.', 'error');
                return;
            }
            
            try {
                showNotification('Generating PDF report...', 'info');
                
                const mainCity = document.getElementById('mainCity').textContent.split(',')[0] || 'Delhi';
                
                const response = await fetch(`${API_BASE_URL}/export/pdf?city=${encodeURIComponent(mainCity)}`, {
                    method: 'GET',
                    headers: {
                        'X-User-Id': currentUser.id.toString()
                    }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `air-quality-report-${mainCity}-${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Report downloaded successfully!', 'success');
                } else {
                    const errorText = await response.text();
                    showNotification('Failed to generate report: ' + errorText, 'error');
                }
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Failed to download report.', 'error');
            }
        }

        // Load user alerts
        async function loadUserAlerts() {
            if (!isLoggedIn) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/users/alerts`, {
                    headers: {
                        'X-User-Id': currentUser.id.toString()
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateAlertsList(data.alerts);
                } else {
                    console.warn('Failed to load user alerts:', data.message);
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        // Update alerts list
        function updateAlertsList(alerts) {
            const alertList = document.getElementById('alertList');
            alertList.innerHTML = '';
            
            if (alerts.length === 0) {
                alertList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No alerts set up yet.</p>';
                return;
            }
            
            alerts.forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'alert-item';
                alertItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${alert.city}, ${alert.country}</strong><br>
                            <small>Threshold: AQI > ${alert.thresholdValue}</small>
                        </div>
                        <button onclick="deleteAlert(${alert.id})" style="background: var(--danger-gradient); border: none; border-radius: 5px; padding: 0.5rem; color: white; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                alertList.appendChild(alertItem);
            });
        }

        // Delete alert
        async function deleteAlert(alertId) {
            try {
                const response = await fetch(`${API_BASE_URL}/alerts/${alertId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`
                    }
                });
                
                if (response.ok) {
                    showNotification('Alert deleted successfully!', 'success');
                    loadUserAlerts();
                } else {
                    showNotification('Failed to delete alert.', 'error');
                }
            } catch (error) {
                console.error('Delete alert error:', error);
                showNotification('Failed to delete alert.', 'error');
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            isLoggedIn = false;
            
            // Clear stored session
            localStorage.removeItem('airSightUser');
            
            // Reset navbar
            const loginBtn = document.querySelector('.login-btn');
            loginBtn.innerHTML = '<i class="fas fa-user"></i> Login';
            loginBtn.onclick = () => openModal('loginModal');
            
            // Remove user menu
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.remove();
            }
            
            // Reset alert list to default
            const alertList = document.getElementById('alertList');
            alertList.innerHTML = `
                <div class="alert-item">
                    <strong>Login Required</strong><br>
                    Please login to view personalized alerts<br>
                    <small>Register to get SMS notifications</small>
                </div>
            `;
            
            showNotification('Logged out successfully!', 'success');
        }

        // Utility functions
        function getAQIColor(aqi) {
            if (aqi <= 50) return 'aqi-good';
            if (aqi <= 100) return 'aqi-moderate';
            if (aqi <= 150) return 'aqi-unhealthy';
            if (aqi <= 200) return 'aqi-very-unhealthy';
            return 'aqi-hazardous';
        }

        function getAQIColorValue(aqi) {
            if (aqi <= 50) return 'var(--neon-green)';
            if (aqi <= 100) return '#ffff00';
            if (aqi <= 150) return '#ff8c00';
            if (aqi <= 200) return '#ff0000';
            return '#8b0000';
        }

        function animateValue(element, start, end, duration) {
            const range = end - start;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const currentValue = Math.floor(start + range * progress);
                
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const dashboard = document.getElementById('dashboard');
            
            if (show) {
                loading.style.display = 'block';
                dashboard.style.opacity = '0.5';
            } else {
                loading.style.display = 'none';
                dashboard.style.opacity = '1';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: var(--card-bg);
                backdrop-filter: blur(20px);
                border: 1px solid var(--glass-border);
                border-radius: 10px;
                padding: 1rem 1.5rem;
                color: var(--text-primary);
                z-index: 3000;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;
            
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            const color = type === 'success' ? 'var(--neon-green)' : type === 'error' ? '#ff0000' : 'var(--neon-blue)';
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-${icon}" style="color: ${color};"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Add slide animations to CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Handle Enter key in search
        document.getElementById('citySearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCity();
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Update last updated time
        function updateLastUpdatedTime() {
            const now = new Date();
            const lastUpdatedElement = document.getElementById('lastUpdated');
            lastUpdatedElement.textContent = 'Just now';
            
            // Update to relative time after 1 minute
            setTimeout(() => {
                const minutes = Math.floor((new Date() - now) / 60000);
                if (minutes < 1) {
                    lastUpdatedElement.textContent = 'Just now';
                } else if (minutes === 1) {
                    lastUpdatedElement.textContent = '1 minute ago';
                } else {
                    lastUpdatedElement.textContent = `${minutes} minutes ago`;
                }
            }, 60000);
        }

        // Real-time updates simulation
        setInterval(() => {
            // Simulate real-time AQI changes
            const currentAqi = parseInt(document.getElementById('mainAqi').textContent);
            const change = Math.floor(Math.random() * 10) - 5; // Random change between -5 and +5
            const newAqi = Math.max(0, Math.min(500, currentAqi + change));
            
            if (newAqi !== currentAqi) {
                document.getElementById('mainAqi').textContent = newAqi;
                
                // Update color and category
                const color = getAQIColor(newAqi);
                document.getElementById('mainAqi').className = `aqi-value ${color}`;
                
                // Update progress ring
                const progressElement = document.getElementById('aqiProgress');
                const circumference = 2 * Math.PI * 90;
                const progress = (newAqi / 300) * circumference;
                progressElement.style.strokeDashoffset = circumference - progress;
                progressElement.style.stroke = getAQIColorValue(newAqi);
                
                updateLastUpdatedTime();
            }
        }, 30000); // Update every 30 seconds

        // Initialize with sample data on load
        setTimeout(() => {
            updateLastUpdatedTime();
        }, 1000);
    </script>
</body>
</html>